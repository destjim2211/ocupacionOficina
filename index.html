
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Ocupación de Oficina — Mensual & Vacaciones</title>
  <style>
    :root{
      --ok:#0ea5e9;      /* azul */
      --warn:#f59e0b;    /* ámbar */
      --bad:#ef4444;     /* rojo */
      --good:#22c55e;    /* verde */
      --bg:#0b1020;      /* fondo */
      --card:#111936;    /* tarjeta */
      --muted:#9aa4bc;   /* texto secundario */
      --text:#e7ecf7;    /* texto principal */
      --grid:#1a254b;    /* líneas tabla */
    }
    html,body{height:100%;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    header{padding:20px 24px;border-bottom:1px solid var(--grid);background:linear-gradient(180deg,#0f1630,transparent)}
    header h1{margin:0;font-size:22px}
    header p{margin:6px 0 0;color:var(--muted)}
    .container{display:grid;grid-template-columns:380px 1fr;gap:20px;padding:20px}
    @media (max-width: 980px){.container{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:16px}
    .card h2{margin:0 0 12px 0;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0}
    label{font-size:13px;color:var(--muted)}
    input[type="number"], input[type="range"], select{
      width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--grid);
      background:#0b1430;color:var(--text)
    }
    input[type="range"]{padding:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .item{background:#0b1430;border:1px solid var(--grid);border-radius:8px;padding:10px}
    .kpi .item .label{font-size:12px;color:var(--muted)}
    .kpi .item .value{font-size:18px;margin-top:4px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--grid);padding:10px;text-align:right;font-variant-numeric:tabular-nums}
    th:first-child, td:first-child{text-align:left}
    th{color:var(--muted);font-weight:600}
    .bar{height:10px;border-radius:6px;background:#0b1430;position:relative;overflow:hidden}
    .bar > span{position:absolute;left:0;top:0;bottom:0;border-radius:6px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--grid);font-size:11px;color:var(--muted)}
    .danger{color:#fff;background:var(--bad);border-color:var(--bad)}
    .warn{background:var(--warn);color:#111}
    .ok{background:var(--good);color:#111}
    .muted{color:var(--muted)}
    footer{padding:12px 20px;border-top:1px solid var(--grid);color:var(--muted);font-size:12px}
    .months{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .mini{background:#0b1430;border:1px solid var(--grid);border-radius:10px;padding:10px}
    .mini h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
    .mini .row{margin:4px 0}
  </style>
</head>
<body>
  <header>
    <h1>Simulador de Ocupación de Oficina — Mensual & Vacaciones</h1>
    <p>Estimación de ocupación por día y por mes con ventanas de vacaciones (julio/agosto y navidad), comparando escenario actual vs. nuevas incorporaciones y calculando la capacidad necesaria para evitar sobreocupación.</p>
  </header>

  <div class="container">
    <!-- Panel de entrada -->
    <section class="card" id="inputs">
      <h2>Parámetros</h2>
      <div class="grid">
        <div>
          <label>Puestos disponibles en oficina</label>
          <input id="capacidad" type="number" min="0" step="1" value="181" />
        </div>
        <div>
          <label>Año de simulación</label>
          <input id="anio" type="number" min="2024" max="2100" step="1" value="2026" />
          <div class="hint">Se usa para contar días laborables por mes y ubicar navidad</div>
        </div>
        <div>
          <label>Empleados totales (actual)</label>
          <input id="total" type="number" min="0" step="1" value="260" />
        </div>
        <div>
          <label>En periodo de prueba (100% presencial)</label>
          <input id="prueba" type="number" min="0" step="1" value="60" />
          <div class="hint">Duración del periodo de prueba: 6 meses</div>
        </div>
        <div>
          <label>Empleados con Kynflex (se calcula)</label>
          <input id="kynflex" type="number" value="200" disabled />
          <div class="hint">Kynflex = Total − En prueba</div>
        </div>
        <div>
          <label>% presencial trimestral Kynflex</label>
          <input id="porc" type="number" min="0" max="100" step="1" value="40" />
          <div class="hint">Ej.: 40% ≈ 2 días/semana</div>
        </div>
        <div>
          <label>Distribución de asistencia Kynflex</label>
          <input id="dist" type="range" min="0" max="100" step="1" value="50" />
          <div class="hint"><span id="distLabel">50%</span> elige <b>Mar+Mié</b>; el resto <b>Mié+Jue</b></div>
        </div>
        <div>
          <label>Vacaciones verano (julio/agosto) — % de plantilla ausente</label>
          <input id="vacVerano" type="number" min="0" max="100" step="1" value="35" />
        </div>
        <div>
          <label>Vacaciones navidad (2ª quincena dic + 1ª semana ene) — % de plantilla ausente</label>
          <input id="vacNavidad" type="number" min="0" max="100" step="1" value="40" />
        </div>
        <div>
          <label>Nuevas incorporaciones hasta marzo (en prueba)</label>
          <input id="nuevosTotal" type="number" min="0" step="1" value="100" />
          <div class="hint">Se pueden distribuir por mes a continuación</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Distribución de nuevas incorporaciones por mes</h2>
        <div class="grid" id="incorporaciones"></div>
        <div class="hint">Los nuevos permanecen 6 meses en prueba y luego pasan a Kynflex automáticamente.</div>
      </div>
    </section>

    <!-- Panel de salida -->
    <section class="card" id="outputs">
      <h2>Resultados semanales (escenario actual vs con nuevas)</h2>
      <div class="two-col">
        <div>
          <div class="row"><span class="tag">Escenario actual</span></div>
          <div id="kpisA" class="kpi"></div>
          <table id="tablaA"></table>
        </div>
        <div>
          <div class="row"><span class="tag warn">Con nuevas incorporaciones</span></div>
          <div id="kpisB" class="kpi"></div>
          <table id="tablaB"></table>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <span class="tag ok">Capacidad necesaria para evitar sobreocupación</span>
      </div>
      <div class="two-col">
        <div class="kpi" id="capNecesariaA"></div>
        <div class="kpi" id="capNecesariaB"></div>
      </div>

      <h2 style="margin-top:24px">Vista mensual (con vacaciones)</h2>
      <div class="two-col">
        <div>
          <div class="row"><span class="tag">Escenario actual</span></div>
          <div class="months" id="mesesA"></div>
        </div>
        <div>
          <div class="row"><span class="tag warn">Con nuevas incorporaciones</span></div>
          <div class="months" id="mesesB"></div>
        </div>
      </div>

    </section>
  </div>

  <footer>
    <span class="muted">Supuestos: Kynflex concentra presencialidad en Mar/Mi/Ju; el % presencial se reparte proporcionalmente. Vacaciones aplican como reducción de asistencia a toda la plantilla en los periodos indicados. Puedes ajustar todos los parámetros.</span>
  </footer>

  <script>
    const days = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
    const mesesN = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

    function fmt(n){
      if (typeof n === 'number') return n.toLocaleString('es-ES');
      return n;
    }

    // Construye inputs de incorporaciones por mes
    function buildIncInputs(){
      const cont = document.getElementById('incorporaciones');
      cont.innerHTML = '';
      for (let m=0; m<12; m++){
        const wrap = document.createElement('div');
        const lab = document.createElement('label');
        lab.textContent = `Nuevos en ${mesesN[m]}`;
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.min = '0'; inp.step = '1';
        // Por defecto: 0 salvo marzo = nuevosTotal
        const base = (m===2) ? +document.getElementById('nuevosTotal').value : 0;
        inp.value = base;
        inp.id = `new_${m}`;
        inp.addEventListener('input', recalc);
        wrap.appendChild(lab); wrap.appendChild(inp);
        cont.appendChild(wrap);
      }
    }

    function getNewPerMonth(){
      const arr = new Array(12).fill(0);
      for (let m=0; m<12; m++){
        const el = document.getElementById(`new_${m}`);
        if (el) arr[m] = +el.value;
      }
      return arr;
    }

    // Cuenta días laborales de un mes y devuelve un array de fechas por día de la semana (1..5)
    function workingDates(year, month){
      const res = {1:[],2:[],3:[],4:[],5:[]};
      const d0 = new Date(year, month, 1);
      for (let d=1; d<=31; d++){
        const dt = new Date(year, month, d);
        if (dt.getMonth() !== month) break;
        const wd = dt.getDay(); // 0=Dom,1=Lun..6=Sáb
        if (wd>=1 && wd<=5) res[wd].push(dt);
      }
      return res;
    }

    function monthsArray(year){
      return Array.from({length:12}, (_,m)=>({m, fechas: workingDates(year,m)}));
    }

    function computeScenarioWeekly(params){
      const {capacidad,total,prueba,porc,dist} = params;
      const K = Math.max(0, total - prueba);
      const weeklyOnsiteDaysPerK = 5 * (porc/100); // p.ej., 2 si 40%
      const p = dist/100; // % de Mar+Mié
      // Pesos: Mar=p, Mi=1, Ju=1-p; Lu=0, Vi=0
      const weights = [0, p, 1, (1-p), 0];
      const sumW = weights.reduce((a,b)=>a+b,0) || 1;
      const kynflexPerDay = weights.map(w => K * (weeklyOnsiteDaysPerK * (w/sumW)));
      const probationPerDay = Array(5).fill(prueba);
      const occ = days.map((_,i)=> Math.round(probationPerDay[i] + kynflexPerDay[i]));
      const weekSum = occ.reduce((a,b)=>a+b,0);
      const dailyAvg = weekSum/5;
      const peakIdx = occ.indexOf(Math.max(...occ));
      const free = occ.map(v => capacidad - v);
      return {K, occ, free, dailyAvg, weeklyTotal: weekSum, peakIdx, capacidad};
    }

    function renderTable(el, model){
      const {occ, capacidad} = model;
      const headers = `<tr><th>Día</th><th>Ocupación</th><th>Barra</th><th>Puestos libres</th></tr>`;
      const rows = occ.map((v,i)=>{
        const ratio = Math.max(0, Math.min(1, v/capacidad));
        let color = 'var(--ok)';
        if (v > capacidad) color = 'var(--bad)';
        else if (v > capacidad*0.85) color = 'var(--warn)';
        else color = 'var(--good)';
        const bar = `<div class="bar"><span style="width:${Math.min(100, ratio*100)}%; background:${color};"></span></div>`;
        const libres = capacidad - v;
        const libreStr = libres >= 0 ? `${fmt(libres)}` : `<span class="tag danger">Faltan ${fmt(-libres)}</span>`;
        return `<tr><td>${days[i]}</td><td>${fmt(v)}</td><td>${bar}</td><td>${libreStr}</td></tr>`;
      }).join('');
      el.innerHTML = headers + rows;
    }

    function renderKPIs(el, model){
      const {occ, dailyAvg, peakIdx, capacidad} = model;
      const peakVal = occ[peakIdx];
      const peakTag = peakVal>capacidad ? `<span class='tag danger'>${fmt(peakVal)} / ${fmt(capacidad)}</span>` : `${fmt(peakVal)} / ${fmt(capacidad)}`;
      el.innerHTML = `
        <div class="item"><div class="label">Pico de ocupación</div><div class="value">${days[peakIdx]} · ${peakTag}</div></div>
        <div class="item"><div class="label">Media diaria (semana tipo)</div><div class="value">${fmt(dailyAvg.toFixed(1))}</div></div>
        <div class="item"><div class="label">Distribución Kynflex</div><div class="value">Mar+Mié: ${(document.getElementById('dist').value)}% · Mié+Jue: ${(100-document.getElementById('dist').value)}%</div></div>
      `;
    }

    // Vacaciones: devuelve factor (0..1) de reducción para una fecha
    function vacationFactor(date, vacVerano, vacNavidad){
      const m = date.getMonth();
      const d = date.getDate();
      let f = 0;
      if (m===6 || m===7){ // Jul(6), Ago(7)
        f = vacVerano/100;
      }
      // 2ª quincena de dic (>=16) y 1ª semana de ene (<=7)
      if ((m===11 && d>=16) || (m===0 && d<=7)){
        f = Math.max(f, vacNavidad/100);
      }
      return f;
    }

    // Ocupación diaria con dinámica de nuevas incorporaciones (6 meses en prueba)
    function occupancyForDate(date, params, newPerMonth){
      const {total, prueba, porc, dist} = params;
      const year = date.getFullYear();
      const month = date.getMonth();
      // Calcular nuevos en prueba activos en esta fecha (han comenzado y no han cumplido 6 meses)
      let nuevosEnPrueba = 0; let nuevosYaK = 0; let nuevosTotales = 0;
      for (let m=0; m<12; m++){
        const n = newPerMonth[m]||0; if (n<=0) continue; nuevosTotales += n;
        // Fecha inicio = primer día del mes m
        const start = new Date(year, m, 1);
        const endProb = new Date(year, m+6, 1); // fin de prueba al llegar al mes m+6
        if (date >= start && date < endProb){
          nuevosEnPrueba += n;
        } else if (date >= endProb){
          nuevosYaK += n;
        }
      }
      const pruebaAct = prueba + nuevosEnPrueba; // todos los de prueba 100% presencial salvo vacaciones
      const totalAct = total + nuevosTotales;     // total del año con incorporaciones
      const Kbase = Math.max(0, totalAct - pruebaAct); // Kynflex incluyendo quienes ya pasaron la prueba

      // Distribución Kynflex por día de la semana
      const p = dist/100; const weights = [0,p,1,(1-p),0]; const sumW = weights.reduce((a,b)=>a+b,0)||1;
      const wd = date.getDay(); // 1..5
      const weeklyOnsiteDaysPerK = 5 * (porc/100);
      const kToday = (wd>=1 && wd<=5) ? Kbase * (weeklyOnsiteDaysPerK * (weights[wd-1]/sumW)) : 0;
      const pruebaToday = (wd>=1 && wd<=5) ? pruebaAct : 0;
      let occ = Math.round(kToday + pruebaToday);
      return {occ, pruebaAct, Kbase};
    }

    function computeMonthly(params, year, vacVerano, vacNavidad, newPerMonth){
      const months = monthsArray(year);
      const perMonth = months.map(({m, fechas})=>{
        let totalDays = 0; let sumOcc = 0; let peak = 0; let picoDia = null; let overDays = 0; let occByDay = {1:0,2:0,3:0,4:0,5:0};
        for (let wd=1; wd<=5; wd++){
          const arr = fechas[wd];
          for (const dt of arr){
            const vacF = vacationFactor(dt, vacVerano, vacNavidad);
            const {occ} = occupancyForDate(dt, params, newPerMonth);
            const occAdj = Math.round(occ * (1 - vacF));
            sumOcc += occAdj; totalDays += 1; occByDay[wd] += occAdj;
            if (occAdj > peak){peak = occAdj; picoDia = new Date(dt);}            
          }
        }
        const dailyAvg = totalDays ? (sumOcc/totalDays) : 0;
        return {monthIndex:m, nombre: mesesN[m], dailyAvg, peak, picoDia, overDays, occByDay};
      });
      return perMonth;
    }

    function renderMonths(el, list, capacidad){
      el.innerHTML = '';
      list.forEach(m => {
        const div = document.createElement('div'); div.className = 'mini';
        const h = document.createElement('h3'); h.textContent = m.nombre; div.appendChild(h);
        const avg = document.createElement('div'); avg.className='row';
        avg.innerHTML = `<span class='muted'>Media diaria</span><span>${fmt(m.dailyAvg.toFixed(1))}</span>`; div.appendChild(avg);
        const peak = document.createElement('div'); peak.className='row';
        const tag = (m.peak>capacidad) ? `<span class='tag danger'>${fmt(m.peak)} / ${fmt(capacidad)}</span>` : `${fmt(m.peak)} / ${fmt(capacidad)}`;
        peak.innerHTML = `<span class='muted'>Pico mensual</span><span>${tag}</span>`; div.appendChild(peak);
        const hint = document.createElement('div'); hint.className='hint';
        hint.textContent = (m.picoDia) ? `Día pico: ${m.picoDia.toLocaleDateString('es-ES', {day:'2-digit', month:'short'})}` : '';
        div.appendChild(hint);
        // Barra
        const barWrap = document.createElement('div'); barWrap.className='bar'; barWrap.style.marginTop='8px';
        const ratio = Math.min(1, m.peak/capacidad); const span = document.createElement('span'); span.style.width = `${ratio*100}%`;
        span.style.background = m.peak>capacidad ? 'var(--bad)' : (m.peak>capacidad*0.85 ? 'var(--warn)' : 'var(--good)');
        barWrap.appendChild(span); div.appendChild(barWrap);
        el.appendChild(div);
      });
      // Ranking de meses por media y por pico
      const byAvg = [...list].sort((a,b)=>b.dailyAvg - a.dailyAvg).slice(0,3);
      const byPeak = [...list].sort((a,b)=>b.peak - a.peak).slice(0,3);
      const rank = document.createElement('div'); rank.className='hint';
      rank.innerHTML = `<b>Top por media:</b> ${byAvg.map(x=>x.nombre).join(', ')} · <b>Top por pico:</b> ${byPeak.map(x=>x.nombre).join(', ')}`;
      el.appendChild(rank);
    }

    function renderCapNecesaria(el, capacidad, maxPeak){
      const needed = Math.ceil(maxPeak);
      const delta = needed - capacidad;
      el.innerHTML = `
        <div class="item"><div class="label">Capacidad actual</div><div class="value">${fmt(capacidad)}</div></div>
        <div class="item"><div class="label">Capacidad necesaria (pico)</div><div class="value">${fmt(needed)}</div></div>
        <div class="item"><div class="label">Diferencia</div><div class="value">${delta>=0?`+${fmt(delta)}`:`${fmt(delta)}`}</div></div>
      `;
    }

    function recalc(){
      const capacidad = +document.getElementById('capacidad').value;
      const anio = +document.getElementById('anio').value;
      const total = +document.getElementById('total').value;
      const prueba = +document.getElementById('prueba').value;
      const porc = +document.getElementById('porc').value;
      const dist = +document.getElementById('dist').value;
      const vacVerano = +document.getElementById('vacVerano').value;
      const vacNavidad = +document.getElementById('vacNavidad').value;
      const nuevosTotal = +document.getElementById('nuevosTotal').value;
      // auto-calc kynflex
      const K = Math.max(0, total - prueba);
      document.getElementById('kynflex').value = K;
      // etiqueta distribución
      document.getElementById('distLabel').textContent = `${dist}%`;

      // Semanal (base sin calendario ni vacaciones)
      const base = computeScenarioWeekly({capacidad,total,prueba,porc,dist});
      const withNewWeekly = computeScenarioWeekly({capacidad,total: total + nuevosTotal,prueba: prueba + nuevosTotal,porc,dist});
      renderKPIs(document.getElementById('kpisA'), base);
      renderTable(document.getElementById('tablaA'), base);
      renderKPIs(document.getElementById('kpisB'), withNewWeekly);
      renderTable(document.getElementById('tablaB'), withNewWeekly);

      // Mensual con calendario + vacaciones + distribución de incorporaciones
      const newPerMonth = getNewPerMonth();
      const monthlyA = computeMonthly({capacidad,total,prueba,porc,dist}, anio, vacVerano, vacNavidad, newPerMonth.map(()=>0));
      const monthlyB = computeMonthly({capacidad,total,prueba,porc,dist}, anio, vacVerano, vacNavidad, newPerMonth);
      renderMonths(document.getElementById('mesesA'), monthlyA, capacidad);
      renderMonths(document.getElementById('mesesB'), monthlyB, capacidad);

      // Capacidad necesaria
      const maxPeakA = Math.max(...monthlyA.map(m=>m.peak));
      const maxPeakB = Math.max(...monthlyB.map(m=>m.peak));
      renderCapNecesaria(document.getElementById('capNecesariaA'), capacidad, maxPeakA);
      renderCapNecesaria(document.getElementById('capNecesariaB'), capacidad, maxPeakB);
    }

    for (const id of ['capacidad','anio','total','prueba','porc','dist','vacVerano','vacNavidad','nuevosTotal']){
      document.getElementById(id).addEventListener('input', recalc);
    }

    // Al cambiar el total de nuevos, reconstuye por defecto la distribución (todo en marzo)
    document.getElementById('nuevosTotal').addEventListener('input', buildIncInputs);

    buildIncInputs();
    recalc();
  </script>
</body>
</html>
